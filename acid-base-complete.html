<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Acid‚ÄìBase Algorithm ‚Äì Mixed Quiz</title>
    <style>
      :root {
        --accent: #0f766e;
        --accent-soft: #ecfdf5;
        --accent-strong: #0d9488;
        --accent-orange: #f97316;
        --accent-orange-dark: #ea580c;
        --border-subtle: #e5e7eb;
        --bg-page: #f3f4f6;
        --bg-card: #ffffff;
        --text-main: #111827;
        --text-muted: #6b7280;
      }

      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        margin: 0;
        padding: 1.5rem;
        background: var(--bg-page);
        color: var(--text-main);
      }

      h1,
      h2,
      h3 {
        margin-top: 0;
      }

      .app {
        max-width: 1100px;
        margin: 0 auto;
        background: var(--bg-card);
        padding: 1.5rem 2rem 2rem;
        border-radius: 14px;
        box-shadow: 0 12px 35px rgba(15, 23, 42, 0.06);
      }

      .layout {
        display: flex;
        gap: 1.5rem;
        margin-top: 1rem;
      }

      .layout-left {
        flex: 0 0 260px;
        border-right: 1px solid var(--border-subtle);
        padding-right: 1.25rem;
        display: flex;
        flex-direction: column;
        font-size: 0.9rem;
      }

      .layout-right {
        flex: 1 1 auto;
        max-height: 70vh;
        overflow-y: auto;
        padding-right: 0.5rem;
        scroll-behavior: smooth;
      }

      .section {
        margin-top: 1rem;
      }

      .pill-list {
        margin: 0.25rem 0 0.75rem;
        padding-left: 0;
        list-style: none;
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
      }

      .pill-list li {
        padding: 0.2rem 0.6rem;
        border-radius: 999px;
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
        font-size: 0.8rem;
      }

      .stepper {
        display: flex;
        align-items: flex-start;
        gap: 1.5rem;
        margin: 1rem 0 1.25rem;
        font-size: 0.8rem;
        justify-content: center;
      }

      .stepper-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
        cursor: pointer;
      }

      .stepper-step.disabled {
        opacity: 0.4;
        cursor: default;
      }

      .stepper-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        border: 2px solid #d1d5db;
        background: #fff;
        transition: background 180ms ease, border-color 180ms ease,
          box-shadow 180ms ease, transform 180ms ease;
      }

      .stepper-step.current .stepper-dot {
        border-color: var(--accent);
        background: var(--accent);
        box-shadow: 0 0 0 4px rgba(20, 184, 166, 0.15);
        transform: scale(1.08);
      }

      .stepper-line {
        flex: 1 1 auto;
        height: 2px;
        background: var(--border-subtle);
        margin-top: 13px;
        border-radius: 999px;
      }

      .stepper-step span {
        white-space: nowrap;
        text-align: center;
      }

      .stepper-step:hover span {
        text-decoration: underline;
      }

      .step-panel {
        opacity: 0;
        transition: opacity 220ms ease-in-out;
      }

      .step-panel.visible {
        opacity: 1;
      }

      .question-card {
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        padding: 1rem 1.25rem 1.05rem;
        margin-bottom: 1rem;
        background: #f9fafb;
      }

      .question-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-bottom: 0.25rem;
      }

      .step-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        color: var(--text-muted);
      }

      .step-label-pill {
        padding: 0.25rem 0.9rem;
        border-radius: 999px;
        background: #e5e7eb;
        color: #111827;
        font-weight: 600;
        letter-spacing: 0.02em;
      }

      .step-label-caption {
        font-size: 0.85rem;
      }

      .decision-question {
        margin-top: 0.6rem;
        font-size: 0.95rem;
      }

      .decision-options {
        margin-top: 0.45rem;
      }

      .decision-options label {
        display: block;
        margin-bottom: 0.35rem;
        cursor: pointer;
        padding: 0.55rem 0.9rem;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        transition: background 160ms ease, border-color 160ms ease,
          box-shadow 160ms ease, transform 120ms ease;
      }

      .decision-options label:hover {
        background: #eef2ff;
        border-color: #c7d2fe;
        box-shadow: 0 0 0 2px #e0e7ff;
        transform: translateY(-1px);
      }

      .decision-options label.selected {
        background: var(--accent-soft);
        border-color: var(--accent-strong);
        box-shadow: 0 0 0 2px rgba(20, 184, 166, 0.35);
        color: var(--accent-strong);
      }

      .decision-options label.wrong {
        background: #fef2f2;
        border-color: #fca5a5;
        box-shadow: 0 0 0 2px #fee2e2;
        color: #b91c1c;
      }

      .decision-options input {
        position: absolute;
        opacity: 0;
        pointer-events: none;
      }

      .decision-feedback {
        margin-top: 0.35rem;
        font-size: 0.85rem;
        color: var(--text-muted);
      }

      .stepper-help {
        margin-top: -0.4rem;
        margin-bottom: 0.8rem;
        font-size: 0.82rem;
        color: var(--text-muted);
        text-align: center;
      }

      .two-step-tree {
        margin-top: 0.75rem;
      }

      .tree-row {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        margin-bottom: 0.6rem;
      }

      .tree-row-label {
        font-size: 0.85rem;
        color: var(--text-muted);
        min-width: 150px;
      }

      .tree-row-label strong {
        display: block;
        font-size: 0.86rem;
        color: var(--text-main);
      }

      .tree-row-connector {
        width: 18px;
        height: 1px;
        background: var(--border-subtle);
        margin-top: 0.9rem;
        flex-shrink: 0;
      }

      .tree-row-options {
        flex: 1;
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem 0.6rem;
      }

      .tree-row-options label {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0;
        white-space: nowrap;
      }

      .tree-row.disabled {
        opacity: 0.45;
      }

      .tree-row.disabled .decision-options,
      .tree-row.disabled .tree-row-options {
        pointer-events: none;
      }

      @media (max-width: 700px) {
        .tree-row {
          flex-direction: column;
          align-items: flex-start;
        }

        .tree-row-connector {
          display: none;
        }
      }

      .buttons {
        margin-top: 1rem;
        display: flex;
        gap: 0.5rem;
      }

      button {
        padding: 0.4rem 0.9rem;
        font-size: 0.9rem;
        border-radius: 999px;
        border: 1px solid var(--accent);
        background: var(--accent);
        color: #fff;
        cursor: pointer;
        transition: background 150ms ease, border-color 150ms ease,
          box-shadow 150ms ease, transform 120ms ease;
      }

      button.secondary {
        background: #fff;
        color: var(--accent);
      }

      button:hover:not([disabled]) {
        background: var(--accent-strong);
        border-color: var(--accent-strong);
        box-shadow: 0 10px 20px rgba(20, 184, 166, 0.25);
        transform: translateY(-1px);
      }

      button.secondary:hover:not([disabled]) {
        background: var(--accent-soft);
        box-shadow: 0 6px 14px rgba(15, 23, 42, 0.12);
      }

      button[disabled] {
        opacity: 0.45;
        cursor: default;
        box-shadow: none;
        transform: none;
      }

      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1.5rem;
        margin-bottom: 1rem;
      }

      .page-header h1 {
        flex: 1;
        margin: 0;
      }

      .global-help-btn {
        padding: 0.6rem 1.3rem;
        font-size: 0.95rem;
        border-radius: 999px;
        border: 1px solid var(--accent-orange);
        background: var(--accent-orange);
        color: #fff;
        cursor: pointer;
        transition: background 150ms ease, border-color 150ms ease,
          box-shadow 150ms ease, transform 120ms ease;
        font-weight: 600;
        white-space: nowrap;
        flex-shrink: 0;
      }

      .global-help-btn:hover {
        background: var(--accent-orange-dark);
        box-shadow: 0 8px 18px rgba(249, 115, 22, 0.3);
        transform: translateY(-1px);
      }

      .show-solution-btn {
        margin-top: 0.75rem;
        padding: 0.55rem 1.2rem;
        font-size: 0.9rem;
        border-radius: 999px;
        border: 1px solid var(--accent);
        background: #fff;
        color: var(--accent-strong);
        cursor: pointer;
        transition: background 150ms ease, border-color 150ms ease,
          box-shadow 150ms ease, transform 120ms ease;
        font-weight: 500;
      }

      .show-solution-btn:hover {
        background: var(--accent-soft);
        box-shadow: 0 6px 14px rgba(15, 23, 42, 0.12);
        transform: translateY(-1px);
      }

      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        animation: fadeIn 200ms ease;
      }

      .modal-overlay.visible {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      .modal-container {
        background: #fff;
        border-radius: 16px;
        max-width: 700px;
        width: 100%;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        animation: slideUp 250ms ease;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--border-subtle);
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        background: #fff;
        z-index: 10;
      }

      .modal-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-main);
        margin: 0;
      }

      .modal-close {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: none;
        background: #f3f4f6;
        color: var(--text-main);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        line-height: 1;
        transition: background 150ms ease, transform 120ms ease;
      }

      .modal-close:hover {
        background: #e5e7eb;
        transform: scale(1.1);
      }

      .modal-body {
        padding: 1.5rem;
        font-size: 0.95rem;
        line-height: 1.6;
      }

      .modal-body p {
        margin: 0.5rem 0;
      }

      .modal-body ul {
        margin: 0.5rem 0 1rem 1.5rem;
        padding: 0;
      }

      .modal-body li {
        margin: 0.25rem 0;
      }

      .modal-body table {
        width: 100%;
        border-collapse: collapse;
        margin: 0.75rem 0;
      }

      .modal-body table th,
      .modal-body table td {
        border: 1px solid var(--border-subtle);
        padding: 0.5rem;
        text-align: center;
      }

      .modal-body table th {
        background: #f9fafb;
        font-weight: 600;
      }

      .modal-body strong {
        color: var(--accent-strong);
      }

      /* Confetti Animation */
      .confetti-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 9999;
        overflow: hidden;
      }

      .confetti {
        position: absolute;
        width: 10px;
        height: 10px;
        background: var(--accent);
        opacity: 0;
        animation: confetti-fall 3s ease-out forwards;
      }

      @keyframes confetti-fall {
        0% {
          opacity: 1;
          transform: translateY(-100vh) rotate(0deg);
        }
        100% {
          opacity: 0;
          transform: translateY(100vh) rotate(720deg);
        }
      }

      .celebration-message {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--accent-soft);
        border: 2px solid var(--accent);
        border-radius: 20px;
        padding: 2rem 3rem;
        text-align: center;
        z-index: 10000;
        opacity: 0;
        animation: celebrationPop 3s ease-out forwards;
        box-shadow: 0 20px 60px rgba(15, 118, 110, 0.3);
      }

      .celebration-message h2 {
        margin: 0 0 0.5rem 0;
        font-size: 2rem;
        color: var(--accent-strong);
      }

      .celebration-message p {
        margin: 0;
        font-size: 1.1rem;
        color: var(--text-main);
      }

      @keyframes celebrationPop {
        0% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.5);
        }
        20% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1.1);
        }
        40% {
          transform: translate(-50%, -50%) scale(0.95);
        }
        60% {
          transform: translate(-50%, -50%) scale(1.02);
        }
        80% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }
        100% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(1);
        }
      }

      @media (max-width: 900px) {
        body {
          padding: 1rem;
        }

        .app {
          padding: 1rem 1.15rem 1.25rem;
        }

        .layout {
          flex-direction: column;
        }

        .layout-left {
          flex: 0 0 auto;
          border-right: none;
          border-bottom: 1px solid var(--border-subtle);
          padding-right: 0;
          padding-bottom: 1rem;
          margin-bottom: 0.75rem;
        }

        .layout-right {
          max-height: none;
          padding-right: 0;
        }

        .stepper {
          flex-wrap: wrap;
          row-gap: 0.75rem;
        }
      }

      @media (max-width: 600px) {
        h1 {
          font-size: 1.4rem;
        }

        body {
          padding: 0.75rem;
        }

        .app {
          padding: 0.85rem 0.85rem 1rem;
          border-radius: 10px;
        }

        .page-header {
          flex-direction: column;
          gap: 1rem;
          align-items: stretch;
        }

        .global-help-btn {
          align-self: flex-end;
        }

        .celebration-message {
          padding: 1.5rem 2rem;
        }

        .celebration-message h2 {
          font-size: 1.5rem;
        }

        .celebration-message p {
          font-size: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="page-header">
        <div>
          <h1>Acid‚ÄìBase Algorithm ‚Äì Mixed Quiz</h1>
          <p>
            This quiz gives you short, mental-arithmetic questions based on the
            Level&nbsp;1 (acetic acid) and Level&nbsp;2 (ethylamine) algorithms, plus basic
            strong acid/strong base ideas. For each scenario, decide
            <strong>what is left in the mixture</strong> and then
            <strong>which calculation type</strong> you should use.
          </p>
        </div>
        <button class="global-help-btn" id="global-help-btn">üí° Help</button>
      </div>

      <div class="layout">
        <div class="layout-left">
          <h2>Targets for this quiz</h2>
          <p>
            Before you see any working, try to reason through each mixture
            mentally:
          </p>
          <ul>
            <li>Which species react completely?</li>
            <li>Which weak species and conjugates are left?</li>
            <li>Which model fits: strong, weak, buffer, or salt hydrolysis?</li>
          </ul>

          <div class="section">
            <h3>Possible "what is left" answers</h3>
            <ul class="pill-list">
              <li>Strong base</li>
              <li>Strong acid</li>
              <li>Weak acid</li>
              <li>Weak base</li>
              <li>Weak acid/base with conjugate base/acid</li>
            </ul>
          </div>

          <div class="section">
            <h3>Possible calculation types</h3>
            <ul class="pill-list">
              <li>Strong base pH calculation</li>
              <li>Strong acid pH calculation</li>
              <li>Weak acid dissociation</li>
              <li>Weak base dissociation</li>
              <li>Salt hydrolysis - weak acid dissociation</li>
              <li>Salt hydrolysis - weak base dissociation</li>
              <li>Buffer calculation</li>
            </ul>
            <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem; padding: 0.5rem 0.75rem; background: #fef3c7; border-left: 3px solid #f59e0b; border-radius: 4px; line-height: 1.4;">
              <strong>Note:</strong> Salt hydrolysis is essentially weak acid/base dissociation. The key difference is you must use the given K<sub>a</sub>/K<sub>b</sub> to calculate the required K<sub>b</sub>/K<sub>a</sub> (via Kw), plus calculate the new concentration.
            </p>
          </div>

          <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem;">
            All detailed tables and derivations are hidden in collapsible panels
            under each question. Expand them only after you have committed to an
            answer.
          </p>
        </div>

        <div class="layout-right">
          <div class="stepper" id="question-stepper"></div>
          <p class="stepper-help">
            Click any question number above to jump between scenarios.
          </p>

          <div id="quiz-container"></div>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="solution-modal">
      <div class="modal-container">
        <div class="modal-header">
          <h3 class="modal-title" id="modal-title">Solution and Working</h3>
          <button class="modal-close" id="modal-close" aria-label="Close modal">√ó</button>
        </div>
        <div class="modal-body" id="modal-body">
          <!-- Solution content will be inserted here -->
        </div>
      </div>
    </div>

    <script>
      const whatLeftOptions = [
        { value: "strong-base", label: "Strong base" },
        { value: "strong-acid", label: "Strong acid" },
        { value: "weak-acid", label: "Weak acid" },
        { value: "weak-base", label: "Weak base" },
        {
          value: "buffer",
          label: "Weak acid/base with conjugate base/acid",
        },
      ];

      const calcOptions = [
        { value: "strong-base-ph", label: "Strong base pH calculation" },
        { value: "strong-acid-ph", label: "Strong acid pH calculation" },
        { value: "weak-acid-dissociation", label: "Weak acid dissociation" },
        { value: "weak-base-dissociation", label: "Weak base dissociation" },
        { value: "salt-hydrolysis-weak-acid", label: "Salt hydrolysis - weak acid dissociation" },
        { value: "salt-hydrolysis-weak-base", label: "Salt hydrolysis - weak base dissociation" },
        { value: "buffer", label: "Buffer calculation" },
      ];

      const helpContent = `
        <h3>Thought Process for Solving These Questions</h3>
        <p><strong>Step 1: Identify what you're given</strong></p>
        <ul>
          <li>Look at the chemicals provided and their concentrations</li>
          <li>Check if they're acids, bases, or salts</li>
          <li>Note if they're strong or weak</li>
        </ul>

        <p><strong>Step 2: Determine if a reaction occurs</strong></p>
        <ul>
          <li>If you have a strong acid + strong base: complete neutralization</li>
          <li>If you have a weak acid + strong base: reaction forms conjugate base</li>
          <li>If you have a weak base + strong acid: reaction forms conjugate acid</li>
          <li>Calculate moles to see if anything is in excess</li>
        </ul>

        <p><strong>Step 3: Identify what's left in solution</strong></p>
        <ul>
          <li><strong>Strong acid or base only?</strong> ‚Üí Simple strong acid/base pH</li>
          <li><strong>Weak acid or base only?</strong> ‚Üí Weak acid/base dissociation</li>
          <li><strong>Both weak acid and conjugate base?</strong> ‚Üí Buffer solution</li>
          <li><strong>Both weak base and conjugate acid?</strong> ‚Üí Buffer solution</li>
          <li><strong>Only conjugate base (from weak acid)?</strong> ‚Üí Salt hydrolysis (basic)</li>
          <li><strong>Only conjugate acid (from weak base)?</strong> ‚Üí Salt hydrolysis (acidic)</li>
        </ul>

        <p><strong>Step 4: Choose the correct calculation method</strong></p>
        <ul>
          <li><strong>Strong acid/base:</strong> pH = -lg[H‚Å∫] or pH = 14 - pOH</li>
          <li><strong>Weak acid/base:</strong> ICE table with Ka or Kb</li>
          <li><strong>Buffer:</strong> Henderson-Hasselbalch equation</li>
          <li><strong>Salt hydrolysis:</strong> Calculate Kb or Ka from Kw, then use ICE table</li>
        </ul>

        <p style="margin-top: 1rem; padding: 0.75rem; background: #fef3c7; border-left: 3px solid #f59e0b; border-radius: 4px;">
          <strong>üí° Key Tip:</strong> Always ask yourself "What species are actually present in solution after any reactions?" This will guide you to the correct calculation type!
        </p>
      `;

      const questions = [
        {
          id: "q1",
          title: "Question 1: Strong Base",
          prompt:
            "Calculate the pH of 0.20 mol dm‚Åª¬≥ NaOH solution.",
          whatLeftAnswer: "strong-base",
          calcAnswer: "strong-base-ph",
          workingHtml: `
            <p><strong>Solution:</strong></p>
            <p>NaOH is a strong base, so it completely dissociates:</p>
            <ul>
              <li>[OH‚Åª] = 0.20 mol dm‚Åª¬≥</li>
              <li>pOH = -lg(0.20) = 0.70</li>
              <li>pH = 14 - pOH = 14 - 0.70 = <strong>13.30</strong></li>
            </ul>
          `,
        },
        {
          id: "q2",
          title: "Question 2: Strong Acid",
          prompt:
            "Calculate the pH of 0.10 mol dm‚Åª¬≥ HCl solution.",
          whatLeftAnswer: "strong-acid",
          calcAnswer: "strong-acid-ph",
          workingHtml: `
            <p><strong>Solution:</strong></p>
            <p>HCl is a strong acid, so it completely dissociates:</p>
            <ul>
              <li>[H‚Å∫] = 0.10 mol dm‚Åª¬≥</li>
              <li>pH = -lg(0.10) = <strong>1.00</strong></li>
            </ul>
          `,
        },
        {
          id: "q3",
          title: "Question 3: Weak Acid",
          prompt:
            "Calculate the pH of 0.10 mol dm‚Åª¬≥ CH‚ÇÉCOOH solution. (K‚Çê for CH‚ÇÉCOOH = 1.8 √ó 10‚Åª‚Åµ)",
          whatLeftAnswer: "weak-acid",
          calcAnswer: "weak-acid-dissociation",
          workingHtml: `
            <p><strong>Solution:</strong></p>
            <p>CH‚ÇÉCOOH is a weak acid, so it partially dissociates.</p>
            <p><strong>Equilibrium:</strong> CH‚ÇÉCOOH ‚áå H‚Å∫ + CH‚ÇÉCOO‚Åª</p>
            <p><strong>ICE Table:</strong></p>
            <table style="width:100%; border-collapse: collapse; margin: 0.5rem 0;">
              <tr><th></th><th>CH‚ÇÉCOOH</th><th>H‚Å∫</th><th>CH‚ÇÉCOO‚Åª</th></tr>
              <tr><td>Initial</td><td>0.10</td><td>0</td><td>0</td></tr>
              <tr><td>Change</td><td>-x</td><td>+x</td><td>+x</td></tr>
              <tr><td>Equilibrium</td><td>0.10 - x</td><td>x</td><td>x</td></tr>
            </table>
            <p><strong>K‚Çê expression:</strong></p>
            <ul>
              <li>K‚Çê = [H‚Å∫][CH‚ÇÉCOO‚Åª] / [CH‚ÇÉCOOH]</li>
              <li>1.8 √ó 10‚Åª‚Åµ = x¬≤ / (0.10 - x)</li>
              <li>Assuming x << 0.10: 1.8 √ó 10‚Åª‚Åµ ‚âà x¬≤ / 0.10</li>
              <li>x¬≤ = 1.8 √ó 10‚Åª‚Å∂</li>
              <li>x = 1.34 √ó 10‚Åª¬≥ mol dm‚Åª¬≥</li>
              <li>[H‚Å∫] = 1.34 √ó 10‚Åª¬≥ mol dm‚Åª¬≥</li>
              <li>pH = -lg(1.34 √ó 10‚Åª¬≥) = <strong>2.87</strong></li>
            </ul>
          `,
        },
        {
          id: "q4",
          title: "Question 4: Weak Base",
          prompt:
            "Calculate the pH of 0.10 mol dm‚Åª¬≥ C‚ÇÇH‚ÇÖNH‚ÇÇ solution. (K<sub>b</sub> for C‚ÇÇH‚ÇÖNH‚ÇÇ = 6.4 √ó 10‚Åª‚Å¥)",
          whatLeftAnswer: "weak-base",
          calcAnswer: "weak-base-dissociation",
          workingHtml: `
            <p><strong>Solution:</strong></p>
            <p>C‚ÇÇH‚ÇÖNH‚ÇÇ is a weak base, so it partially dissociates.</p>
            <p><strong>Equilibrium:</strong> C‚ÇÇH‚ÇÖNH‚ÇÇ + H‚ÇÇO ‚áå C‚ÇÇH‚ÇÖNH‚ÇÉ‚Å∫ + OH‚Åª</p>
            <p><strong>ICE Table:</strong></p>
            <table style="width:100%; border-collapse: collapse; margin: 0.5rem 0;">
              <tr><th></th><th>C‚ÇÇH‚ÇÖNH‚ÇÇ</th><th>C‚ÇÇH‚ÇÖNH‚ÇÉ‚Å∫</th><th>OH‚Åª</th></tr>
              <tr><td>Initial</td><td>0.10</td><td>0</td><td>0</td></tr>
              <tr><td>Change</td><td>-x</td><td>+x</td><td>+x</td></tr>
              <tr><td>Equilibrium</td><td>0.10 - x</td><td>x</td><td>x</td></tr>
            </table>
            <p><strong>K<sub>b</sub> expression:</strong></p>
            <ul>
              <li>K<sub>b</sub> = [C‚ÇÇH‚ÇÖNH‚ÇÉ‚Å∫][OH‚Åª] / [C‚ÇÇH‚ÇÖNH‚ÇÇ]</li>
              <li>6.4 √ó 10‚Åª‚Å¥ = x¬≤ / (0.10 - x)</li>
              <li>Assuming x << 0.10: 6.4 √ó 10‚Åª‚Å¥ ‚âà x¬≤ / 0.10</li>
              <li>x¬≤ = 6.4 √ó 10‚Åª‚Åµ</li>
              <li>x = 8.0 √ó 10‚Åª¬≥ mol dm‚Åª¬≥</li>
              <li>[OH‚Åª] = 8.0 √ó 10‚Åª¬≥ mol dm‚Åª¬≥</li>
              <li>pOH = -lg(8.0 √ó 10‚Åª¬≥) = 2.10</li>
              <li>pH = 14 - 2.10 = <strong>11.90</strong></li>
            </ul>
          `,
        },
        {
          id: "q5",
          title: "Question 5: Weak Acid + Conjugate Base",
          prompt:
            "Mix 50 cm¬≥ of 1.0 mol dm‚Åª¬≥ CH‚ÇÉCOOH with 50 cm¬≥ of 1.0 mol dm‚Åª¬≥ CH‚ÇÉCOO‚ÅªNa‚Å∫. Calculate the pH of the resulting solution. (K‚Çê for CH‚ÇÉCOOH = 1.8 √ó 10‚Åª‚Åµ)",
          whatLeftAnswer: "buffer",
          calcAnswer: "buffer",
          workingHtml: `
            <p><strong>Step 1: Determine what's present</strong></p>
            <ul>
              <li>CH‚ÇÉCOOH and CH‚ÇÉCOO‚Åª do not react with each other</li>
              <li>After mixing: both weak acid and conjugate base are present ‚Üí Buffer solution</li>
            </ul>
            <p><strong>Step 2: Calculate concentrations after mixing</strong></p>
            <ul>
              <li>Total volume = 50 + 50 = 100 cm¬≥</li>
              <li>[CH‚ÇÉCOOH] = (1.0 √ó 50) / 100 = 0.50 mol dm‚Åª¬≥</li>
              <li>[CH‚ÇÉCOO‚Åª] = (1.0 √ó 50) / 100 = 0.50 mol dm‚Åª¬≥</li>
            </ul>
            <p><strong>Step 3: Use Henderson-Hasselbalch equation</strong></p>
            <ul>
              <li>pH = pK‚Çê + lg([CH‚ÇÉCOO‚Åª] / [CH‚ÇÉCOOH])</li>
              <li>pK‚Çê = -lg(1.8 √ó 10‚Åª‚Åµ) = 4.74</li>
              <li>pH = 4.74 + lg(0.50 / 0.50)</li>
              <li>pH = 4.74 + 0 = <strong>4.74</strong></li>
            </ul>
          `,
        },
        {
          id: "q6",
          title: "Question 6: Weak Acid + Strong Base",
          prompt:
            "Mix 70 cm¬≥ of 1.0 mol dm‚Åª¬≥ CH‚ÇÉCOOH with 30 cm¬≥ of 1.0 mol dm‚Åª¬≥ NaOH. Calculate the pH of the resulting solution. (K‚Çê for CH‚ÇÉCOOH = 1.8 √ó 10‚Åª‚Åµ)",
          whatLeftAnswer: "buffer",
          calcAnswer: "buffer",
          workingHtml: `
            <p><strong>Step 1: Initial reaction (strong base reacts completely with weak acid)</strong></p>
            <ul>
              <li>Moles CH‚ÇÉCOOH = 1.0 √ó 0.070 = 0.070 mol</li>
              <li>Moles NaOH = 1.0 √ó 0.030 = 0.030 mol</li>
              <li>Reaction: CH‚ÇÉCOOH + OH‚Åª ‚Üí CH‚ÇÉCOO‚Åª + H‚ÇÇO</li>
            </ul>
            <table style="width:100%; border-collapse: collapse; margin: 0.5rem 0;">
              <tr><th></th><th>CH‚ÇÉCOOH</th><th>OH‚Åª</th><th>CH‚ÇÉCOO‚Åª</th></tr>
              <tr><td>Initial (mol)</td><td>0.070</td><td>0.030</td><td>0</td></tr>
              <tr><td>Change (mol)</td><td>-0.030</td><td>-0.030</td><td>+0.030</td></tr>
              <tr><td>Final (mol)</td><td>0.040</td><td>0</td><td>0.030</td></tr>
            </table>
            <p><strong>Step 2: What's left?</strong></p>
            <ul>
              <li>Excess CH‚ÇÉCOOH and CH‚ÇÉCOO‚Åª formed ‚Üí Buffer solution</li>
            </ul>
            <p><strong>Step 3: Calculate concentrations</strong></p>
            <ul>
              <li>Total volume = 70 + 30 = 100 cm¬≥ = 0.100 dm¬≥</li>
              <li>[CH‚ÇÉCOOH] = 0.040 / 0.100 = 0.40 mol dm‚Åª¬≥</li>
              <li>[CH‚ÇÉCOO‚Åª] = 0.030 / 0.100 = 0.30 mol dm‚Åª¬≥</li>
            </ul>
            <p><strong>Step 4: Use Henderson-Hasselbalch equation</strong></p>
            <ul>
              <li>pH = pK‚Çê + lg([CH‚ÇÉCOO‚Åª] / [CH‚ÇÉCOOH])</li>
              <li>pH = 4.74 + lg(0.30 / 0.40)</li>
              <li>pH = 4.74 + lg(0.75)</li>
              <li>pH = 4.74 - 0.12 = <strong>4.62</strong></li>
            </ul>
          `,
        },
        {
          id: "q7",
          title: "Question 7: Weak Base + Conjugate Acid",
          prompt:
            "Mix 50 cm¬≥ of 1.0 mol dm‚Åª¬≥ C‚ÇÇH‚ÇÖNH‚ÇÇ with 50 cm¬≥ of 1.0 mol dm‚Åª¬≥ C‚ÇÇH‚ÇÖNH‚ÇÉ‚Å∫Cl‚Åª. Calculate the pH of the resulting solution. (K<sub>b</sub> for C‚ÇÇH‚ÇÖNH‚ÇÇ = 6.4 √ó 10‚Åª‚Å¥)",
          whatLeftAnswer: "buffer",
          calcAnswer: "buffer",
          workingHtml: `
            <p><strong>Step 1: Determine what's present</strong></p>
            <ul>
              <li>C‚ÇÇH‚ÇÖNH‚ÇÇ and C‚ÇÇH‚ÇÖNH‚ÇÉ‚Å∫ do not react with each other</li>
              <li>After mixing: both weak base and conjugate acid are present ‚Üí Buffer solution</li>
            </ul>
            <p><strong>Step 2: Calculate concentrations after mixing</strong></p>
            <ul>
              <li>Total volume = 50 + 50 = 100 cm¬≥</li>
              <li>[C‚ÇÇH‚ÇÖNH‚ÇÇ] = (1.0 √ó 50) / 100 = 0.50 mol dm‚Åª¬≥</li>
              <li>[C‚ÇÇH‚ÇÖNH‚ÇÉ‚Å∫] = (1.0 √ó 50) / 100 = 0.50 mol dm‚Åª¬≥</li>
            </ul>
            <p><strong>Step 3: Use Henderson-Hasselbalch equation (base form)</strong></p>
            <ul>
              <li>pOH = pK<sub>b</sub> + lg([C‚ÇÇH‚ÇÖNH‚ÇÉ‚Å∫] / [C‚ÇÇH‚ÇÖNH‚ÇÇ])</li>
              <li>pK<sub>b</sub> = -lg(6.4 √ó 10‚Åª‚Å¥) = 3.19</li>
              <li>pOH = 3.19 + lg(0.50 / 0.50)</li>
              <li>pOH = 3.19 + 0 = 3.19</li>
              <li>pH = 14 - 3.19 = <strong>10.81</strong></li>
            </ul>
          `,
        },
        {
          id: "q8",
          title: "Question 8: Weak Base + Strong Acid",
          prompt:
            "Mix 70 cm¬≥ of 1.0 mol dm‚Åª¬≥ C‚ÇÇH‚ÇÖNH‚ÇÇ with 30 cm¬≥ of 1.0 mol dm‚Åª¬≥ HCl. Calculate the pH of the resulting solution. (K<sub>b</sub> for C‚ÇÇH‚ÇÖNH‚ÇÇ = 6.4 √ó 10‚Åª‚Å¥)",
          whatLeftAnswer: "buffer",
          calcAnswer: "buffer",
          workingHtml: `
            <p><strong>Step 1: Initial reaction (strong acid reacts completely with weak base)</strong></p>
            <ul>
              <li>Moles C‚ÇÇH‚ÇÖNH‚ÇÇ = 1.0 √ó 0.070 = 0.070 mol</li>
              <li>Moles HCl = 1.0 √ó 0.030 = 0.030 mol</li>
              <li>Reaction: C‚ÇÇH‚ÇÖNH‚ÇÇ + H‚Å∫ ‚Üí C‚ÇÇH‚ÇÖNH‚ÇÉ‚Å∫</li>
            </ul>
            <table style="width:100%; border-collapse: collapse; margin: 0.5rem 0;">
              <tr><th></th><th>C‚ÇÇH‚ÇÖNH‚ÇÇ</th><th>H‚Å∫</th><th>C‚ÇÇH‚ÇÖNH‚ÇÉ‚Å∫</th></tr>
              <tr><td>Initial (mol)</td><td>0.070</td><td>0.030</td><td>0</td></tr>
              <tr><td>Change (mol)</td><td>-0.030</td><td>-0.030</td><td>+0.030</td></tr>
              <tr><td>Final (mol)</td><td>0.040</td><td>0</td><td>0.030</td></tr>
            </table>
            <p><strong>Step 2: What's left?</strong></p>
            <ul>
              <li>Excess C‚ÇÇH‚ÇÖNH‚ÇÇ and C‚ÇÇH‚ÇÖNH‚ÇÉ‚Å∫ formed ‚Üí Buffer solution</li>
            </ul>
            <p><strong>Step 3: Calculate concentrations</strong></p>
            <ul>
              <li>Total volume = 70 + 30 = 100 cm¬≥ = 0.100 dm¬≥</li>
              <li>[C‚ÇÇH‚ÇÖNH‚ÇÇ] = 0.040 / 0.100 = 0.40 mol dm‚Åª¬≥</li>
              <li>[C‚ÇÇH‚ÇÖNH‚ÇÉ‚Å∫] = 0.030 / 0.100 = 0.30 mol dm‚Åª¬≥</li>
            </ul>
            <p><strong>Step 4: Use Henderson-Hasselbalch equation (base form)</strong></p>
            <ul>
              <li>pOH = pK<sub>b</sub> + lg([C‚ÇÇH‚ÇÖNH‚ÇÉ‚Å∫] / [C‚ÇÇH‚ÇÖNH‚ÇÇ])</li>
              <li>pOH = 3.19 + lg(0.30 / 0.40)</li>
              <li>pOH = 3.19 + lg(0.75)</li>
              <li>pOH = 3.19 - 0.12 = 3.07</li>
              <li>pH = 14 - 3.07 = <strong>10.93</strong></li>
            </ul>
          `,
        },
        {
          id: "q9",
          title: "Question 9: Salt Hydrolysis (from weak acid)",
          prompt:
            "Mix 50 cm¬≥ of 1.0 mol dm‚Åª¬≥ CH‚ÇÉCOOH with 50 cm¬≥ of 1.0 mol dm‚Åª¬≥ NaOH. Calculate the pH of the resulting solution. (K‚Çê for CH‚ÇÉCOOH = 1.8 √ó 10‚Åª‚Åµ)",
          whatLeftAnswer: "weak-base",
          calcAnswer: "salt-hydrolysis-weak-base",
          workingHtml: `
            <p><strong>Step 1: Initial reaction (complete neutralization)</strong></p>
            <ul>
              <li>Moles CH‚ÇÉCOOH = 1.0 √ó 0.050 = 0.050 mol</li>
              <li>Moles NaOH = 1.0 √ó 0.050 = 0.050 mol</li>
              <li>Reaction: CH‚ÇÉCOOH + OH‚Åª ‚Üí CH‚ÇÉCOO‚Åª + H‚ÇÇO</li>
            </ul>
            <table style="width:100%; border-collapse: collapse; margin: 0.5rem 0;">
              <tr><th></th><th>CH‚ÇÉCOOH</th><th>OH‚Åª</th><th>CH‚ÇÉCOO‚Åª</th></tr>
              <tr><td>Initial (mol)</td><td>0.050</td><td>0.050</td><td>0</td></tr>
              <tr><td>Change (mol)</td><td>-0.050</td><td>-0.050</td><td>+0.050</td></tr>
              <tr><td>Final (mol)</td><td>0</td><td>0</td><td>0.050</td></tr>
            </table>
            <p><strong>Step 2: What's left?</strong></p>
            <ul>
              <li>Only CH‚ÇÉCOO‚Åª remains ‚Üí Salt hydrolysis</li>
            </ul>
            <p><strong>Step 3: Calculate concentration</strong></p>
            <ul>
              <li>Total volume = 50 + 50 = 100 cm¬≥ = 0.100 dm¬≥</li>
              <li>[CH‚ÇÉCOO‚Åª] = 0.050 / 0.100 = 0.50 mol dm‚Åª¬≥</li>
            </ul>
            <p><strong>Step 4: Hydrolysis calculation</strong></p>
            <ul>
              <li>Find K<sub>b</sub>: K<sub>b</sub> = Kw / K<sub>a</sub> = (1.0 √ó 10‚Åª¬π‚Å¥) / (1.8 √ó 10‚Åª‚Åµ) = 5.56 √ó 10‚Åª¬π‚Å∞</li>
              <li>Equilibrium: CH‚ÇÉCOO‚Åª + H‚ÇÇO ‚áå CH‚ÇÉCOOH + OH‚Åª</li>
            </ul>
            <p><strong>ICE Table:</strong></p>
            <table style="width:100%; border-collapse: collapse; margin: 0.5rem 0;">
              <tr><th></th><th>CH‚ÇÉCOO‚Åª</th><th>CH‚ÇÉCOOH</th><th>OH‚Åª</th></tr>
              <tr><td>Initial</td><td>0.50</td><td>0</td><td>0</td></tr>
              <tr><td>Change</td><td>-x</td><td>+x</td><td>+x</td></tr>
              <tr><td>Equilibrium</td><td>0.50 - x</td><td>x</td><td>x</td></tr>
            </table>
            <ul>
              <li>K<sub>b</sub> = x¬≤ / (0.50 - x) ‚âà x¬≤ / 0.50</li>
              <li>5.56 √ó 10‚Åª¬π‚Å∞ = x¬≤ / 0.50</li>
              <li>x¬≤ = 2.78 √ó 10‚Åª¬π‚Å∞</li>
              <li>x = 1.67 √ó 10‚Åª‚Åµ mol dm‚Åª¬≥</li>
              <li>[OH‚Åª] = 1.67 √ó 10‚Åª‚Åµ mol dm‚Åª¬≥</li>
              <li>pOH = -lg(1.67 √ó 10‚Åª‚Åµ) = 4.78</li>
              <li>pH = 14 - 4.78 = <strong>9.22</strong></li>
            </ul>
          `,
        },
        {
          id: "q10",
          title: "Question 10: Salt Hydrolysis (from weak base)",
          prompt:
            "Mix 50 cm¬≥ of 1.0 mol dm‚Åª¬≥ C‚ÇÇH‚ÇÖNH‚ÇÇ with 50 cm¬≥ of 1.0 mol dm‚Åª¬≥ HCl. Calculate the pH of the resulting solution. (K<sub>b</sub> for C‚ÇÇH‚ÇÖNH‚ÇÇ = 6.4 √ó 10‚Åª‚Å¥)",
          whatLeftAnswer: "weak-acid",
          calcAnswer: "salt-hydrolysis-weak-acid",
          workingHtml: `
            <p><strong>Step 1: Initial reaction (complete neutralization)</strong></p>
            <ul>
              <li>Moles C‚ÇÇH‚ÇÖNH‚ÇÇ = 1.0 √ó 0.050 = 0.050 mol</li>
              <li>Moles HCl = 1.0 √ó 0.050 = 0.050 mol</li>
              <li>Reaction: C‚ÇÇH‚ÇÖNH‚ÇÇ + H‚Å∫ ‚Üí C‚ÇÇH‚ÇÖNH‚ÇÉ‚Å∫</li>
            </ul>
            <table style="width:100%; border-collapse: collapse; margin: 0.5rem 0;">
              <tr><th></th><th>C‚ÇÇH‚ÇÖNH‚ÇÇ</th><th>H‚Å∫</th><th>C‚ÇÇH‚ÇÖNH‚ÇÉ‚Å∫</th></tr>
              <tr><td>Initial (mol)</td><td>0.050</td><td>0.050</td><td>0</td></tr>
              <tr><td>Change (mol)</td><td>-0.050</td><td>-0.050</td><td>+0.050</td></tr>
              <tr><td>Final (mol)</td><td>0</td><td>0</td><td>0.050</td></tr>
            </table>
            <p><strong>Step 2: What's left?</strong></p>
            <ul>
              <li>Only C‚ÇÇH‚ÇÖNH‚ÇÉ‚Å∫ remains ‚Üí Salt hydrolysis</li>
            </ul>
            <p><strong>Step 3: Calculate concentration</strong></p>
            <ul>
              <li>Total volume = 50 + 50 = 100 cm¬≥ = 0.100 dm¬≥</li>
              <li>[C‚ÇÇH‚ÇÖNH‚ÇÉ‚Å∫] = 0.050 / 0.100 = 0.50 mol dm‚Åª¬≥</li>
            </ul>
            <p><strong>Step 4: Hydrolysis calculation</strong></p>
            <ul>
              <li>Find K<sub>a</sub>: K<sub>a</sub> = Kw / K<sub>b</sub> = (1.0 √ó 10‚Åª¬π‚Å¥) / (6.4 √ó 10‚Åª‚Å¥) = 1.56 √ó 10‚Åª¬π¬π</li>
              <li>Equilibrium: C‚ÇÇH‚ÇÖNH‚ÇÉ‚Å∫ + H‚ÇÇO ‚áå C‚ÇÇH‚ÇÖNH‚ÇÇ + H‚Å∫</li>
            </ul>
            <p><strong>ICE Table:</strong></p>
            <table style="width:100%; border-collapse: collapse; margin: 0.5rem 0;">
              <tr><th></th><th>C‚ÇÇH‚ÇÖNH‚ÇÉ‚Å∫</th><th>C‚ÇÇH‚ÇÖNH‚ÇÇ</th><th>H‚Å∫</th></tr>
              <tr><td>Initial</td><td>0.50</td><td>0</td><td>0</td></tr>
              <tr><td>Change</td><td>-x</td><td>+x</td><td>+x</td></tr>
              <tr><td>Equilibrium</td><td>0.50 - x</td><td>x</td><td>x</td></tr>
            </table>
            <ul>
              <li>K‚Çê = x¬≤ / (0.50 - x) ‚âà x¬≤ / 0.50</li>
              <li>1.56 √ó 10‚Åª¬π¬π = x¬≤ / 0.50</li>
              <li>x¬≤ = 7.8 √ó 10‚Åª¬π¬≤</li>
              <li>x = 2.79 √ó 10‚Åª‚Å∂ mol dm‚Åª¬≥</li>
              <li>[H‚Å∫] = 2.79 √ó 10‚Åª‚Å∂ mol dm‚Åª¬≥</li>
              <li>pH = -lg(2.79 √ó 10‚Åª‚Å∂) = <strong>5.55</strong></li>
            </ul>
          `,
        },
      ];

      const stepperEl = document.getElementById("question-stepper");
      const quizContainer = document.getElementById("quiz-container");

      let currentQuestionIndex = 0;

      function renderStepper() {
        stepperEl.innerHTML = "";
        questions.forEach((q, index) => {
          const step = document.createElement("div");
          step.className = "stepper-step";
          step.dataset.index = index;

          const dot = document.createElement("div");
          dot.className = "stepper-dot";
          step.appendChild(dot);

          const label = document.createElement("span");
          label.textContent = `Q${index + 1}`;
          step.appendChild(label);

          step.addEventListener("click", () => {
            goToQuestion(index);
          });

          stepperEl.appendChild(step);

          if (index < questions.length - 1) {
            const line = document.createElement("div");
            line.className = "stepper-line";
            stepperEl.appendChild(line);
          }
        });
      }

      function updateStepper() {
        const steps = stepperEl.querySelectorAll(".stepper-step");
        steps.forEach((el) => {
          const idx = Number(el.dataset.index);
          el.classList.remove("current");
          if (idx === currentQuestionIndex) {
            el.classList.add("current");
          }
        });
      }

      function renderQuestions() {
        quizContainer.innerHTML = "";

        questions.forEach((q, index) => {
          const card = document.createElement("div");
          card.className = "question-card step-panel";
          card.dataset.index = index;

          const meta = document.createElement("div");
          meta.className = "question-meta";
          meta.innerHTML = `<span>Question ${index + 1} of ${
            questions.length
          }</span>`;
          card.appendChild(meta);

          const prompt = document.createElement("p");
          prompt.style.fontSize = "1.05rem";
          prompt.style.fontWeight = "500";
          prompt.style.marginTop = "0.5rem";
          prompt.innerHTML = q.prompt;
          card.appendChild(prompt);

          const tree = document.createElement("div");
          tree.className = "two-step-tree";

          const row1 = document.createElement("div");
          row1.className = "tree-row";
          row1.innerHTML = `
            <div class="tree-row-label">
              <strong>Part 1</strong>
              <span>What is left in the mixture?</span>
            </div>
          `;
          const connector1 = document.createElement("div");
          connector1.className = "tree-row-connector";
          row1.appendChild(connector1);

          const whatOptions = document.createElement("div");
          whatOptions.className = "tree-row-options decision-options";
          whatOptions.dataset.role = "what-options";

          const updateNextButton = () => {
            const nextBtn = card.querySelector('button[data-role="next"]');
            if (!nextBtn) return;
            const part1Correct = card.dataset.part1Correct === "true";
            const part2Correct = card.dataset.part2Correct === "true";
            nextBtn.disabled = !(part1Correct && part2Correct);
          };

          card.dataset.part1Correct = "false";
          card.dataset.part2Correct = "false";

          whatLeftOptions.forEach((opt) => {
            const id = `${q.id}-what-${opt.value}`;
            const label = document.createElement("label");
            label.htmlFor = id;
            label.innerHTML = `
              <input type="radio" name="${q.id}-what" id="${id}" value="${opt.value}" />
              ${opt.label}
            `;
            label.addEventListener("click", () => {
              whatOptions
                .querySelectorAll("label")
                .forEach((l) => l.classList.remove("selected", "wrong"));
              const isCorrect = opt.value === q.whatLeftAnswer;
              card.dataset.part1Correct = isCorrect ? "true" : "false";

              if (isCorrect) {
                label.classList.add("selected");
                whatFeedback.textContent =
                  "Good ‚Äì now match this to a calculation type.";
                row2.classList.remove("disabled");

                // Check if this is the last question and part 2 is already correct
                if (index === questions.length - 1 && card.dataset.part2Correct === "true") {
                  setTimeout(() => {
                    celebrate();
                  }, 500);
                }
              } else {
                label.classList.add("wrong");
                whatFeedback.textContent =
                  "Think carefully about which species remain in solution after any reaction, then try again.";
                row2.classList.add("disabled");
                card.dataset.part2Correct = "false";
                calcOptionsEl
                  .querySelectorAll("input[type='radio']")
                  .forEach((input) => (input.checked = false));
                calcOptionsEl
                  .querySelectorAll("label")
                  .forEach((l) => l.classList.remove("selected", "wrong"));
                calcFeedback.textContent = "";
              }

              updateNextButton();
            });
            whatOptions.appendChild(label);
          });

          row1.appendChild(whatOptions);
          tree.appendChild(row1);

          const row2 = document.createElement("div");
          row2.className = "tree-row disabled";
          row2.dataset.role = "part2-row";
          row2.innerHTML = `
            <div class="tree-row-label">
              <strong>Part 2</strong>
              <span>Which calculation type fits what is left?</span>
            </div>
          `;
          const connector2 = document.createElement("div");
          connector2.className = "tree-row-connector";
          row2.appendChild(connector2);

          const calcOptionsEl = document.createElement("div");
          calcOptionsEl.className = "tree-row-options decision-options";
          calcOptionsEl.dataset.role = "calc-options";

          calcOptions.forEach((opt) => {
            const id = `${q.id}-calc-${opt.value}`;
            const label = document.createElement("label");
            label.htmlFor = id;
            label.innerHTML = `
              <input type="radio" name="${q.id}-calc" id="${id}" value="${opt.value}" />
              ${opt.label}
            `;
            label.addEventListener("click", () => {
              calcOptionsEl
                .querySelectorAll("label")
                .forEach((l) => l.classList.remove("selected", "wrong"));
              const isCorrect = opt.value === q.calcAnswer;
              card.dataset.part2Correct = isCorrect ? "true" : "false";

              if (isCorrect) {
                label.classList.add("selected");
                calcFeedback.textContent =
                  "Correct ‚Äì this calculation type matches what is left.";

                // Check if this is the last question and both parts are correct
                if (index === questions.length - 1 && card.dataset.part1Correct === "true") {
                  setTimeout(() => {
                    celebrate();
                  }, 500);
                }
              } else {
                label.classList.add("wrong");
                calcFeedback.textContent =
                  "Not yet. Match the calculation to what is left in solution.";
              }

              updateNextButton();
            });
            calcOptionsEl.appendChild(label);
          });

          row2.appendChild(calcOptionsEl);
          tree.appendChild(row2);

          card.appendChild(tree);

          const whatFeedback = document.createElement("div");
          whatFeedback.className = "decision-feedback";
          whatFeedback.dataset.role = "what-feedback";
          card.appendChild(whatFeedback);

          const calcFeedback = document.createElement("div");
          calcFeedback.className = "decision-feedback";
          calcFeedback.dataset.role = "calc-feedback";
          card.appendChild(calcFeedback);

          const buttons = document.createElement("div");
          buttons.className = "buttons";

          const nextBtn = document.createElement("button");
          nextBtn.textContent =
            index === questions.length - 1 ? "Finish" : "Next question";
          nextBtn.disabled = true;
          nextBtn.dataset.role = "next";
          nextBtn.addEventListener("click", () => {
            if (index < questions.length - 1) {
              goToQuestion(index + 1);
            } else {
              goToQuestion(0);
            }
          });

          const resetBtn = document.createElement("button");
          resetBtn.textContent = "Reset";
          resetBtn.className = "secondary";
          resetBtn.addEventListener("click", () => {
            resetQuestion(card);
          });

          buttons.appendChild(nextBtn);
          buttons.appendChild(resetBtn);
          card.appendChild(buttons);

          const showSolutionBtn = document.createElement("button");
          showSolutionBtn.className = "show-solution-btn";
          showSolutionBtn.textContent = "Show solution";
          showSolutionBtn.addEventListener("click", () => {
            openModal("Solution and Working", q.workingHtml);
          });

          card.appendChild(showSolutionBtn);

          quizContainer.appendChild(card);
        });
      }

      // Shuffle array function
      function shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
      }

      function openModal(title, content) {
        const modal = document.getElementById("solution-modal");
        const modalTitle = document.getElementById("modal-title");
        const modalBody = document.getElementById("modal-body");

        modalTitle.textContent = title;
        modalBody.innerHTML = content;
        modal.classList.add("visible");
      }

      function closeModal() {
        const modal = document.getElementById("solution-modal");
        modal.classList.remove("visible");
      }

      // Set up modal close handlers
      document.getElementById("modal-close").addEventListener("click", closeModal);
      document.getElementById("solution-modal").addEventListener("click", (e) => {
        if (e.target.id === "solution-modal") {
          closeModal();
        }
      });

      // Close modal on Escape key
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeModal();
        }
      });

      function celebrate() {
        // Create confetti container
        const confettiContainer = document.createElement("div");
        confettiContainer.className = "confetti-container";
        document.body.appendChild(confettiContainer);

        // Create confetti pieces
        const colors = ["#0f766e", "#14b8a6", "#2dd4bf", "#5eead4", "#99f6e4", "#f97316", "#fb923c"];
        const confettiCount = 150;

        for (let i = 0; i < confettiCount; i++) {
          const confetti = document.createElement("div");
          confetti.className = "confetti";
          confetti.style.left = Math.random() * 100 + "%";
          confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.animationDelay = Math.random() * 0.5 + "s";
          confetti.style.animationDuration = Math.random() * 2 + 2 + "s";
          confettiContainer.appendChild(confetti);
        }

        // Create celebration message
        const celebrationMsg = document.createElement("div");
        celebrationMsg.className = "celebration-message";
        celebrationMsg.innerHTML = `
          <h2>üéâ Well Done! üéâ</h2>
          <p>You've completed all 10 questions!</p>
        `;
        document.body.appendChild(celebrationMsg);

        // Clean up after animations
        setTimeout(() => {
          confettiContainer.remove();
          celebrationMsg.remove();
        }, 3000);
      }

      function resetQuestion(card) {
        const whatOptions = card.querySelector('[data-role="what-options"]');
        const calcOptionsEl = card.querySelector('[data-role="calc-options"]');
        const whatFeedback = card.querySelector('[data-role="what-feedback"]');
        const calcFeedback = card.querySelector('[data-role="calc-feedback"]');
        const part2Row = card.querySelector('[data-role="part2-row"]');
        const nextBtn = card.querySelector('button[data-role="next"]');

        whatOptions
          .querySelectorAll("input[type='radio']")
          .forEach((input) => (input.checked = false));
        calcOptionsEl
          .querySelectorAll("input[type='radio']")
          .forEach((input) => (input.checked = false));

        whatOptions
          .querySelectorAll("label")
          .forEach((l) => l.classList.remove("selected", "wrong"));
        calcOptionsEl
          .querySelectorAll("label")
          .forEach((l) => l.classList.remove("selected", "wrong"));

        whatFeedback.textContent = "";
        calcFeedback.textContent = "";

        if (part2Row) {
          part2Row.classList.add("disabled");
        }
        if (nextBtn) {
          nextBtn.disabled = true;
        }
        card.dataset.part1Correct = "false";
        card.dataset.part2Correct = "false";
      }

      function goToQuestion(index) {
        currentQuestionIndex = index;
        const panels = quizContainer.querySelectorAll(".step-panel");
        panels.forEach((panel, idx) => {
          if (idx === index) {
            panel.hidden = false;
            panel.classList.add("visible");
          } else {
            panel.hidden = true;
            panel.classList.remove("visible");
          }
        });
        updateStepper();
      }

      // Global help button handler
      document.getElementById("global-help-btn").addEventListener("click", () => {
        openModal("Help: Thought Process", helpContent);
      });

      // Shuffle questions on load
      const shuffledQuestions = shuffleArray(questions);
      // Replace the original questions array with shuffled version
      questions.length = 0;
      questions.push(...shuffledQuestions);

      renderStepper();
      renderQuestions();
      goToQuestion(0);
    </script>
  </body>
  </html>
