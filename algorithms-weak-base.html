<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Acid-Base Algorithm – Level 2 (Ethylamine)</title>
    <style>
      :root {
        --accent: #0f766e;
        --accent-soft: #ecfdf5;
        --accent-strong: #0d9488;
        --accent-orange: #f97316;
        --accent-orange-dark: #ea580c;
        --border-subtle: #e5e7eb;
        --bg-page: #f3f4f6;
        --bg-card: #ffffff;
        --text-main: #111827;
        --text-muted: #6b7280;
      }

      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        margin: 0;
        padding: 1.5rem;
        background: var(--bg-page);
        color: var(--text-main);
      }

      h1,
      h2,
      h3 {
        margin-top: 0;
      }

      .app {
        max-width: 1100px;
        margin: 0 auto;
        background: var(--bg-card);
        padding: 1.5rem 2rem 2rem;
        border-radius: 14px;
        box-shadow: 0 12px 35px rgba(15, 23, 42, 0.06);
      }

      .layout {
        display: flex;
        gap: 1.5rem;
        margin-top: 1rem;
      }

      .layout-left {
        flex: 0 0 270px;
        border-right: 1px solid var(--border-subtle);
        padding-right: 1.25rem;
        display: flex;
        flex-direction: column;
      }

      .layout-right {
        flex: 1 1 auto;
        max-height: 70vh;
        overflow-y: auto;
        padding-right: 0.5rem;
        scroll-behavior: smooth;
      }

      .section {
        margin-top: 1rem;
      }

      .stepper {
        display: flex;
        align-items: flex-start;
        gap: 1.5rem;
        margin-top: 1.25rem;
        font-size: 0.8rem;
        justify-content: center;
      }

      .stepper-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
        cursor: pointer;
      }

      .stepper-step.disabled {
        opacity: 0.4;
        cursor: default;
      }

      .stepper-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        border: 2px solid #d1d5db;
        background: #fff;
        transition: background 180ms ease, border-color 180ms ease,
          box-shadow 180ms ease, transform 180ms ease;
      }

      .stepper-step.current .stepper-dot {
        border-color: var(--accent);
        background: var(--accent);
        box-shadow: 0 0 0 4px rgba(20, 184, 166, 0.15);
        transform: scale(1.08);
      }

      .stepper-step.completed .stepper-dot {
        border-color: var(--accent);
        background: var(--accent);
      }

      .stepper-line {
        flex: 1 1 auto;
        height: 2px;
        background: var(--border-subtle);
        margin-top: 13px;
        border-radius: 999px;
      }

      .stepper-step span {
        white-space: nowrap;
        text-align: center;
      }

      .stepper-step.completed + .stepper-line,
      .stepper-step.current + .stepper-line {
        background: var(--accent);
      }

      .step-panel {
        opacity: 0;
        transition: opacity 220ms ease-in-out;
      }

      .step-panel.visible {
        opacity: 1;
      }

      .card-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      .card {
        border: 1px solid #e5e7eb;
        border-radius: 999px;
        padding: 0.7rem 1.2rem;
        flex: 1 1 200px;
        cursor: pointer;
        background: #f9fafb;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        transition: background 160ms ease, border-color 160ms ease,
          box-shadow 160ms ease, color 160ms ease, transform 160ms ease;
      }

      .card.selected {
        border-color: var(--accent);
        background: var(--accent-soft);
        color: var(--accent-strong);
        box-shadow: 0 0 0 2px rgba(20, 184, 166, 0.3);
        transform: translateY(-1px);
      }

      .card h3 {
        margin: 0 0 0.25rem;
        font-size: 1rem;
      }

      .card p {
        margin: 0;
        font-size: 0.9rem;
      }

      .options-list {
        margin-top: 0.5rem;
      }

      .options-list label {
        display: block;
        margin-bottom: 0.4rem;
        cursor: pointer;
      }

      .case-pill {
        display: block;
        padding: 0.65rem 1rem;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        font-size: 0.9rem;
        text-align: center;
        transition: background 150ms ease, border-color 150ms ease,
          box-shadow 150ms ease, color 150ms ease;
      }

      .options-list label:hover .case-pill {
        background: #eef2ff;
        border-color: #c7d2fe;
        box-shadow: 0 0 0 2px #e0e7ff;
      }

      .case-pill.selected {
        background: var(--accent-soft);
        color: var(--accent-strong);
        border-color: var(--accent-strong);
        box-shadow: 0 0 0 2px rgba(20, 184, 166, 0.35);
      }

      .decision-question {
        margin-top: 0.75rem;
        font-size: 0.95rem;
      }

      .decision-options {
        margin-top: 0.5rem;
      }

      .decision-options label {
        display: block;
        margin-bottom: 0.35rem;
        cursor: pointer;
        padding: 0.55rem 0.9rem;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        transition: background 160ms ease, border-color 160ms ease,
          box-shadow 160ms ease, transform 120ms ease;
      }

      .decision-options label:hover {
        background: #eef2ff;
        border-color: #c7d2fe;
        box-shadow: 0 0 0 2px #e0e7ff;
        transform: translateY(-1px);
      }

      .decision-options label.selected {
        background: var(--accent-soft);
        border-color: var(--accent-strong);
        box-shadow: 0 0 0 2px rgba(20, 184, 166, 0.35);
        color: var(--accent-strong);
      }

      .decision-options label.wrong {
        background: #fef2f2;
        border-color: #fca5a5;
        box-shadow: 0 0 0 2px #fee2e2;
        color: #b91c1c;
      }

      .decision-options input {
        position: absolute;
        opacity: 0;
        pointer-events: none;
      }

      .decision-feedback {
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: var(--text-muted);
      }

      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 0.75rem;
      }

      th,
      td {
        border: 1px solid #e5e7eb;
        padding: 0.4rem 0.5rem;
        text-align: center;
        font-size: 0.85rem;
      }

      th {
        background: #f9fafb;
        font-weight: 600;
      }

      .tree {
        margin-top: 0.75rem;
        font-size: 0.9rem;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .tree-level {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        align-items: center;
      }

      .tree-level + .tree-level {
        margin-top: 0.5rem;
      }

      .tree-node {
        padding: 0.35rem 0.9rem;
        border-radius: 999px;
        border: 1px solid #d1d5db;
        background: #f9fafb;
        min-width: 160px;
        text-align: center;
        transition: box-shadow 160ms ease, border-color 160ms ease,
          background 160ms ease, transform 120ms ease;
      }

      .tree-node.root {
        font-weight: 600;
        background: #eef2ff;
      }

      .tree-node.highlight {
        box-shadow: 0 0 0 2px rgba(191, 219, 254, 0.95);
        border-color: var(--accent);
        transform: translateY(-1px);
      }

      .tree-node.leaf.active {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent-strong);
        font-weight: 600;
      }

      .tree-connector {
        width: 1px;
        background: #d1d5db;
        height: 14px;
      }

      .tree-branch {
        width: 110%;
        height: 1px;
        background: #d1d5db;
      }

      .mixture-strip {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.75rem;
        font-size: 0.88rem;
      }

      .mixture-strip strong {
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--text-muted);
      }

      .mixture-pill {
        padding: 0.25rem 0.6rem;
        border-radius: 999px;
        background: var(--accent-soft);
        border: 1px solid rgba(20, 184, 166, 0.35);
        font-size: 0.8rem;
        color: var(--accent-strong);
      }

      .step-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        color: var(--text-muted);
      }

      .step-label-pill {
        padding: 0.25rem 0.9rem;
        border-radius: 999px;
        background: #e5e7eb;
        color: #111827;
        font-weight: 600;
        letter-spacing: 0.02em;
      }

      .step-label-caption {
        font-size: 0.85rem;
      }

      .step-label.active .step-label-pill {
        background: var(--accent-soft);
        color: var(--accent-strong);
      }

      .step-label.active .step-label-caption {
        color: var(--accent-strong);
      }

      .buttons {
        margin-top: 1.5rem;
        display: flex;
        gap: 0.5rem;
      }

      button {
        padding: 0.4rem 0.9rem;
        font-size: 0.9rem;
        border-radius: 999px;
        border: 1px solid var(--accent);
        background: var(--accent);
        color: #fff;
        cursor: pointer;
        transition: background 150ms ease, border-color 150ms ease,
          box-shadow 150ms ease, transform 120ms ease;
      }

      button.secondary {
        background: #fff;
        color: var(--accent);
      }

      button:hover:not([disabled]) {
        background: var(--accent-strong);
        border-color: var(--accent-strong);
        box-shadow: 0 10px 20px rgba(20, 184, 166, 0.25);
        transform: translateY(-1px);
      }

      button.secondary:hover:not([disabled]) {
        background: var(--accent-soft);
        box-shadow: 0 6px 14px rgba(15, 23, 42, 0.12);
      }

      button[disabled] {
        opacity: 0.45;
        cursor: default;
        box-shadow: none;
        transform: none;
      }

      #restart-btn {
        padding: 0.6rem 1.4rem;
        font-size: 0.95rem;
        border-radius: 999px;
        border: none;
        background: var(--accent-orange);
        color: #fff;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
      }

      #restart-btn:hover {
        background: var(--accent-orange-dark);
      }

      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .modal-backdrop.show {
        display: flex;
      }

      .modal {
        background: #fff;
        padding: 1.25rem 1.5rem 1.5rem;
        border-radius: 10px;
        max-width: 800px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.25);
      }

      .modal-header {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 0.5rem;
        position: relative;
      }

      .modal-header h3 {
        margin: 0;
      }

      .close-btn {
        border: none;
        background: transparent;
        font-size: 1rem;
        cursor: pointer;
        position: absolute;
        top: 6px;
        right: 10px;
      }

      #modal-body p {
        margin: 0.35rem 0 0.75rem;
        line-height: 1.5;
        font-size: 0.92rem;
      }

      #modal-body ol {
        margin: 0.25rem 0 0.75rem 1.25rem;
        padding: 0;
        font-size: 0.9rem;
      }

      #modal-body table {
        margin: 0.75rem 0;
        font-size: 0.85rem;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <h1>Acid-Base Algorithm &mdash; Level 2</h1>
      <p>
        Use the right panel to work through the guided steps for each mixture.
        The tree and mixture strip on the left act as your map and reference.
      </p>

      <div class="layout">
        <!-- LEFT: tree + mixture + restart -->
        <div class="layout-left">
          <h2>Flow of decisions</h2>
          <p style="font-size: 0.9rem; color: var(--text-muted);">
            We focus only on the weak base C₂H₅NH₂ and its conjugate acid
            C₂H₅NH₃⁺. Use this tree to see which calculation applies.
          </p>
          <div class="tree">
            <div class="tree-level">
              <div class="tree-node root">Start: What is in the mixture?</div>
            </div>
            <div class="tree-level">
              <div class="tree-connector"></div>
            </div>
            <div class="tree-level">
              <div class="tree-node">
                Focus on C₂H₅NH₂ and C₂H₅NH₃⁺ (ignore H₂O and Cl⁻)
              </div>
            </div>
            <div class="tree-level">
              <div class="tree-connector"></div>
            </div>
            <div class="tree-level">
              <div class="tree-branch"></div>
            </div>
            <div class="tree-level">
              <div class="tree-node leaf" data-node="weak-base">
                Weak base dissociation<br />
                (C₂H₅NH₂ only)
              </div>
              <div class="tree-node leaf" data-node="buffer">
                Buffer calculation<br />
                (C₂H₅NH₂ + C₂H₅NH₃⁺)
              </div>
              <div class="tree-node leaf" data-node="salt-hydrolysis">
                Salt hydrolysis<br />
                (C₂H₅NH₃⁺ only)
              </div>
            </div>
          </div>

          <div class="stepper" id="stepper">
            <div class="stepper-step current" data-step="1">
              <div class="stepper-dot"></div>
              <span>Choose reagents</span>
            </div>
            <div class="stepper-line"></div>
            <div class="stepper-step disabled" data-step="2">
              <div class="stepper-dot"></div>
              <span>Choose volumes</span>
            </div>
            <div class="stepper-line"></div>
            <div class="stepper-step disabled" data-step="3">
              <div class="stepper-dot"></div>
              <span>Predict mixture</span>
            </div>
            <div class="stepper-line"></div>
            <div class="stepper-step disabled" data-step="4">
              <div class="stepper-dot"></div>
              <span>Choose calculation</span>
            </div>
          </div>

          <div class="mixture-strip" id="mixture-strip" hidden>
            <strong>Mixture chosen:</strong>
            <span class="mixture-pill" id="mixture-pill"></span>
          </div>

          <div class="buttons" style="justify-content: center; margin-top: 0.75rem;">
            <button id="restart-btn">Restart</button>
          </div>
        </div>

        <!-- RIGHT: interactive steps -->
        <div class="layout-right">
          <!-- Step 1 -->
          <div class="section step-panel" id="step-1">
            <div class="step-label" data-step-label="1">
              <span class="step-label-pill">STEP 1 OF 4</span>
              <span class="step-label-caption">Choose one mixture to explore.</span>
            </div>
            <h2>Step 1: What is in the initial reaction mixture?</h2>
            <p>Select the set of reagents placed together.</p>
            <div class="card-row">
              <div class="card" data-reagent-set="base">
                <h3>C₂H₅NH₂ only</h3>
                <p>Only the weak base ethylamine is present.</p>
              </div>
              <div class="card" data-reagent-set="acid-base">
                <h3>HCl + C₂H₅NH₂</h3>
                <p>Strong acid with a weak base.</p>
              </div>
              <div class="card" data-reagent-set="base-salt">
                <h3>C₂H₅NH₂ + C₂H₅NH₃⁺Cl⁻</h3>
                <p>Weak base and its conjugate acid (buffer pair).</p>
              </div>
            </div>
          </div>

          <!-- Step 2 -->
          <div class="section step-panel" id="step-2" hidden>
            <div class="step-label" data-step-label="2">
              <span class="step-label-pill">STEP 2 OF 4</span>
              <span class="step-label-caption">Pick a volume combination.</span>
            </div>
            <h2>Step 2: Choose the concentrations and volumes</h2>
            <p id="step-2-description"></p>
            <div class="options-list" id="case-options"></div>
          </div>

          <!-- Step 3 -->
          <div class="section step-panel" id="step-3" hidden>
            <div class="step-label" data-step-label="3">
              <span class="step-label-pill">STEP 3 OF 4</span>
              <span class="step-label-caption">Decide what is left in solution.</span>
            </div>
            <h2>Step 3: Predict what is left</h2>
            <p>
              Before you see any calculations, think carefully about which species
              react and what is left in solution.
            </p>
            <div class="decision-question">
              <p>
                Looking only at C₂H₅NH₂ and C₂H₅NH₃⁺ (ignore H₂O and Cl⁻), what is
                left in the mixture <em>after</em> any reaction?
              </p>
              <div class="decision-options" id="student-decision-options">
                <label>
                  <input
                    type="radio"
                    name="student-decision"
                    value="weak-base"
                  />
                  Only C₂H₅NH₂ is present
                </label>
                <label>
                  <input
                    type="radio"
                    name="student-decision"
                    value="salt-hydrolysis"
                  />
                  Only C₂H₅NH₃⁺ is present
                </label>
                <label>
                  <input
                    type="radio"
                    name="student-decision"
                    value="buffer"
                  />
                  A mixture of C₂H₅NH₂ and C₂H₅NH₃⁺ is present
                </label>
              </div>
              <div class="decision-feedback" id="decision-feedback"></div>
            </div>
          </div>

          <!-- Step 4 -->
          <div class="section step-panel" id="step-4" hidden>
            <div class="step-label" data-step-label="4">
              <span class="step-label-pill">STEP 4 OF 4</span>
              <span class="step-label-caption">Choose the type of calculation.</span>
            </div>
            <h2>Step 4: Choose which calculation to use</h2>
            <p>
              Based on what is left in solution, which type of calculation is
              appropriate for this mixture?
            </p>
            <div id="step4-table-container"></div>
          <div class="decision-options" id="calc-decision-options">
              <label>
                <input
                  type="radio"
                  name="calc-decision"
                  value="weak-base"
                />
                Weak base dissociation calculation
              </label>
              <label>
                <input
                  type="radio"
                  name="calc-decision"
                  value="buffer"
                />
                Buffer calculation (C₂H₅NH₂ / C₂H₅NH₃⁺)
              </label>
              <label>
                <input
                  type="radio"
                  name="calc-decision"
                  value="salt-hydrolysis"
                />
                Salt hydrolysis calculation (C₂H₅NH₃⁺)
              </label>
            </div>
            <div class="decision-feedback" id="calc-decision-feedback"></div>
            <div class="buttons" style="justify-content: flex-start; margin-top: 1rem;">
              <button id="show-working-btn" class="secondary">
                Show step-by-step working
              </button>
            </div>
            <div class="buttons" id="right-restart-container-2" style="justify-content: flex-start; margin-top: 0.5rem;" hidden>
              <button id="restart-btn-right-2" class="secondary">
                Restart
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Derivation modal -->
    <div class="modal-backdrop" id="modal-backdrop">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-header">
          <h3 id="modal-title">Derivation</h3>
          <button class="close-btn" id="close-modal" aria-label="Close derivation">
            ×
          </button>
        </div>
        <div id="modal-body"></div>
      </div>
    </div>

    <script>
      const KbEthylamine = 6.4e-4;

      const scenarios = {
        base: {
          label: "C₂H₅NH₂ only",
          description:
            "We place only the weak base C₂H₅NH₂ in water. All solutions are 1 mol dm⁻³.",
          cases: [
            {
              id: "base-0.1-100",
              label: "C₂H₅NH₂ 100 cm³ (0.1 mol dm⁻³)",
              baseConc: 0.1,
              baseVolumeCm3: 100,
            },
          ],
        },
        "acid-base": {
          label: "HCl + C₂H₅NH₂",
          description:
            "We mix a strong acid (HCl) with a weak base (C₂H₅NH₂). The proton-transfer reaction goes essentially to completion.",
          cases: [
            {
              id: "ab-1-50-50",
              label: "50 cm³ HCl with 50 cm³ C₂H₅NH₂ (1 mol dm⁻³ each)",
              acidConc: 1,
              acidVolumeCm3: 50,
              baseConc: 1,
              baseVolumeCm3: 50,
            },
            {
              id: "ab-1-30-70",
              label: "30 cm³ HCl with 70 cm³ C₂H₅NH₂ (1 mol dm⁻³ each)",
              acidConc: 1,
              acidVolumeCm3: 30,
              baseConc: 1,
              baseVolumeCm3: 70,
            },
          ],
        },
        "base-salt": {
          label: "C₂H₅NH₂ + C₂H₅NH₃⁺Cl⁻",
          description:
            "We mix a weak base with its conjugate acid C₂H₅NH₃⁺ (from C₂H₅NH₃⁺Cl⁻). Together they form a buffer pair.",
          cases: [
            {
              id: "bs-1-70-30",
              label:
                "70 cm³ C₂H₅NH₂ with 30 cm³ C₂H₅NH₃⁺Cl⁻ (1 mol dm⁻³ each)",
              baseConc: 1,
              baseVolumeCm3: 70,
              saltConc: 1,
              saltVolumeCm3: 30,
            },
            {
              id: "bs-1-50-50",
              label:
                "50 cm³ C₂H₅NH₂ with 50 cm³ C₂H₅NH₃⁺Cl⁻ (1 mol dm⁻³ each)",
              baseConc: 1,
              baseVolumeCm3: 50,
              saltConc: 1,
              saltVolumeCm3: 50,
            },
          ],
        },
      };

      let currentStep = 1;
      let selectedReagentSet = null;
      let selectedCaseId = null;
      let computedState = null;

      const stepperEl = document.getElementById("stepper");
      const stepSections = {
        1: document.getElementById("step-1"),
        2: document.getElementById("step-2"),
        3: document.getElementById("step-3"),
        4: document.getElementById("step-4"),
      };
      const stepLabels = document.querySelectorAll("[data-step-label]");

      const caseOptionsEl = document.getElementById("case-options");
      const step2DescEl = document.getElementById("step-2-description");
      const mixtureStrip = document.getElementById("mixture-strip");
      const mixturePill = document.getElementById("mixture-pill");
      const step4TableContainer = document.getElementById(
        "step4-table-container"
      );

      const studentDecisionOptions = document.getElementById(
        "student-decision-options"
      );
      const decisionFeedback = document.getElementById("decision-feedback");

      const calcDecisionOptions = document.getElementById(
        "calc-decision-options"
      );
      const calcDecisionFeedback = document.getElementById(
        "calc-decision-feedback"
      );

      const decisionNodes = document.querySelectorAll(".tree-node.leaf");

      const restartBtn = document.getElementById("restart-btn");
      const showWorkingBtn = document.getElementById("show-working-btn");
      const modalBackdrop = document.getElementById("modal-backdrop");
      const closeModalBtn = document.getElementById("close-modal");
      const modalTitle = document.getElementById("modal-title");
      const modalBody = document.getElementById("modal-body");
      const rightRestartContainer = document.getElementById(
        "right-restart-container-2"
      );
      const restartBtnRight = document.getElementById("restart-btn-right-2");

      function moles(conc, volumeCm3) {
        return conc * (volumeCm3 / 1000);
      }

      function showSection(stepNumber, shown) {
        const el = stepSections[stepNumber];
        if (!el) return;
        el.hidden = !shown;
        if (shown) {
          el.classList.add("visible");
        } else {
          el.classList.remove("visible");
        }
      }

      function updateStepper() {
        const steps = stepperEl.querySelectorAll(".stepper-step");
        steps.forEach((el) => {
          const step = Number(el.dataset.step);
          el.classList.remove("current", "completed", "disabled");
          if (step === currentStep) {
            el.classList.add("current");
          } else if (step < currentStep) {
            el.classList.add("completed");
          } else {
            el.classList.add("disabled");
          }
        });
      }

      function updateStepLabels() {
        stepLabels.forEach((label) => {
          const step = Number(label.dataset.stepLabel);
          if (step === currentStep) {
            label.classList.add("active");
          } else {
            label.classList.remove("active");
          }
        });
      }

      function updateTreeHighlights() {
        const rootNode = document.querySelector(".tree-node.root");
        rootNode.classList.add("highlight");

        decisionNodes.forEach((n) => {
          n.classList.remove("highlight");
          n.classList.remove("active");
        });

        if (currentStep >= 3 && computedState) {
          const nodeEl = document.querySelector(
            '.tree-node.leaf[data-node="' + computedState.classification + '"]'
          );
          if (nodeEl) {
            nodeEl.classList.add("highlight");
          }
        }

        if (currentStep === 4 && computedState) {
          const nodeEl = document.querySelector(
            '.tree-node.leaf[data-node="' + computedState.classification + '"]'
          );
          if (nodeEl) {
            nodeEl.classList.add("active");
          }
        }
      }

      function goToStep(step) {
        currentStep = step;
        Object.keys(stepSections).forEach((key) => {
          const num = Number(key);
          showSection(num, num === step);
        });
        updateStepper();
        updateStepLabels();
        updateTreeHighlights();
        if (rightRestartContainer) {
          rightRestartContainer.hidden = step !== 4;
        }
      }

      function selectReagentSet(key) {
        selectedReagentSet = key;
        selectedCaseId = null;
        computedState = null;

        document
          .querySelectorAll('.card[data-reagent-set]')
          .forEach((card) => {
            if (card.dataset.reagentSet === key) {
              card.classList.add("selected");
            } else {
              card.classList.remove("selected");
            }
          });

        populateCaseOptions();
        mixtureStrip.hidden = true;
        goToStep(2);
      }

      function populateCaseOptions() {
        const scenario = scenarios[selectedReagentSet];
        if (!scenario) return;

        step2DescEl.textContent = scenario.description;

        caseOptionsEl.innerHTML = "";
        scenario.cases.forEach((c) => {
          const label = document.createElement("label");
          label.dataset.caseId = c.id;
          const pill = document.createElement("span");
          pill.className = "case-pill";
          pill.textContent = c.label;
          label.appendChild(pill);
          label.addEventListener("click", () => {
            selectCase(c.id);
          });
          if (c.id === selectedCaseId) {
            pill.classList.add("selected");
          }
          caseOptionsEl.appendChild(label);
        });
      }

      function selectCase(caseId) {
        selectedCaseId = caseId;
        computedState = computeState();
        document.querySelectorAll(".case-pill").forEach((pill) => {
          const parent = pill.parentElement;
          if (parent && parent.dataset.caseId === caseId) {
            pill.classList.add("selected");
          } else {
            pill.classList.remove("selected");
          }
        });

        if (computedState) {
          mixturePill.textContent = computedState.caseLabel;
          mixtureStrip.hidden = false;
        } else {
          mixtureStrip.hidden = true;
        }

        resetQuizState();
        goToStep(3);
      }

      function computeState() {
        if (!selectedReagentSet || !selectedCaseId) return null;
        const scenario = scenarios[selectedReagentSet];
        const chosen = scenario.cases.find((c) => c.id === selectedCaseId);
        if (!chosen) return null;

        const totalVolumeCm3 =
          (chosen.baseVolumeCm3 || 0) +
          (chosen.acidVolumeCm3 || 0) +
          (chosen.saltVolumeCm3 || 0);
        const totalVolumeL = totalVolumeCm3 / 1000;

        const state = {
          reagentSet: selectedReagentSet,
          caseLabel: chosen.label,
          totalVolumeL,
          nBaseInitial: chosen.baseConc
            ? moles(chosen.baseConc, chosen.baseVolumeCm3)
            : 0,
          nAcidInitial: chosen.acidConc
            ? moles(chosen.acidConc, chosen.acidVolumeCm3)
            : 0,
          nSaltInitial: chosen.saltConc
            ? moles(chosen.saltConc, chosen.saltVolumeCm3)
            : 0,
        };

        if (selectedReagentSet === "acid-base") {
          const nB = state.nBaseInitial;
          const nA = state.nAcidInitial;
          const reacted = Math.min(nB, nA);
          state.nBaseFinal = nB - reacted;
          state.nAcidFinal = nA - reacted;
          state.nSaltFinal = reacted;
        } else if (selectedReagentSet === "base-salt") {
          state.nBaseFinal = state.nBaseInitial;
          state.nAcidFinal = 0;
          state.nSaltFinal = state.nSaltInitial;
        } else if (selectedReagentSet === "base") {
          state.nBaseFinal = state.nBaseInitial;
          state.nAcidFinal = 0;
          state.nSaltFinal = 0;
        }

        state.classification = classifyMixture(
          state.nBaseFinal,
          state.nSaltFinal
        );

        return state;
      }

      function classifyMixture(nBase, nSalt) {
        const eps = 1e-9;
        const hasBase = nBase > eps;
        const hasSalt = nSalt > eps;
        if (hasBase && !hasSalt) return "weak-base";
        if (hasBase && hasSalt) return "buffer";
        if (!hasBase && hasSalt) return "salt-hydrolysis";
        return "none";
      }

      function resetQuizState() {
        decisionFeedback.textContent = "";
        calcDecisionFeedback.textContent = "";
        step4TableContainer.innerHTML = "";

        studentDecisionOptions
          .querySelectorAll("label")
          .forEach((l) => l.classList.remove("selected", "wrong"));
        calcDecisionOptions
          .querySelectorAll("label")
          .forEach((l) => l.classList.remove("selected", "wrong"));
      }

      function renderStep4Table() {
        if (!computedState) return;
        const s = computedState;
        const eps = 1e-9;
        const totalV = s.totalVolumeL || 0;

        const rows = [];
        function addRow(label, n) {
          if (n > eps) {
            const conc = totalV > 0 ? n / totalV : 0;
            rows.push({
              label,
              n: n.toFixed(3),
              conc: conc.toFixed(3),
            });
          }
        }

        addRow("C₂H₅NH₂", s.nBaseFinal || 0);
        addRow("C₂H₅NH₃⁺", s.nSaltFinal || 0);
        if (s.reagentSet === "acid-base") {
          addRow("H⁺ (from HCl)", s.nAcidFinal || 0);
        }

        if (!rows.length) {
          step4TableContainer.innerHTML = "";
          return;
        }

        const table = document.createElement("table");
        table.innerHTML = `
          <thead>
            <tr>
              <th>Species</th>
              <th>Amount present (mol)</th>
              <th>Concentration (mol dm⁻³)</th>
            </tr>
          </thead>
          <tbody>
            ${rows
              .map(
                (r) =>
                  `<tr><td>${r.label}</td><td>${r.n}</td><td>${r.conc}</td></tr>`
              )
              .join("")}
          </tbody>
        `;
        step4TableContainer.innerHTML = "";
        step4TableContainer.appendChild(table);
      }

      function handleStudentDecision(value) {
        if (!computedState) return;
        const inputs = studentDecisionOptions.querySelectorAll(
          'input[name="student-decision"]'
        );
        inputs.forEach((i) => {
          const label = i.closest("label");
          if (!label) return;
          label.classList.remove("selected", "wrong");
          if (i.value === value) {
            label.classList.add("selected");
          }
        });

        const correct = value === computedState.classification;
        if (correct) {
          decisionFeedback.textContent =
            "Correct &mdash; that matches what is left in solution. Here is a summary of the species present.";
          calcDecisionFeedback.textContent = "";
          renderStep4Table();
          goToStep(4);
        } else {
          decisionFeedback.textContent =
            "Not quite. Think again about which species react and what is left. Use the tree on the left as a hint.";
          const wrongLabel = Array.from(inputs).find(
            (i) => i.value === value
          )?.closest("label");
          if (wrongLabel) {
            wrongLabel.classList.add("wrong");
          }
        }
        updateTreeHighlights();
      }

      function handleCalcDecision(value) {
        if (!computedState) return;
        const inputs = calcDecisionOptions.querySelectorAll(
          'input[name="calc-decision"]'
        );
        inputs.forEach((i) => {
          const label = i.closest("label");
          if (!label) return;
          label.classList.remove("selected", "wrong");
          if (i.value === value) {
            label.classList.add("selected");
          }
        });

        const correct = value === computedState.classification;
        if (correct) {
          calcDecisionFeedback.textContent =
            "Nice choice: this is the correct calculation for this mixture.";
        } else {
          calcDecisionFeedback.textContent =
            "That calculation does not match what is left in solution. Use the tree on the left to reconsider.";
          const wrongInput = Array.from(inputs).find(
            (i) => i.value === value
          );
          const wrongLabel = wrongInput ? wrongInput.closest("label") : null;
          if (wrongLabel) {
            wrongLabel.classList.remove("selected");
            wrongLabel.classList.add("wrong");
          }
        }
        updateTreeHighlights();
      }

      function getModalContent(kind, state) {
        if (!state) {
          return {
            title: "Derivation",
            body:
              "<p>Select a mixture and complete the flow to see the derivation for weak base dissociation, buffer behaviour, or salt hydrolysis.</p>",
          };
        }

        if (kind === "weak-base") {
          const totalV = state.totalVolumeL || 0;
          const c0 =
            totalV > 0 && state.nBaseFinal
              ? (state.nBaseFinal / totalV).toFixed(3)
              : "C₀";
          return {
            title: "Weak base dissociation (C₂H₅NH₂)",
            body: `
              <p>This walkthrough shows the equilibrium treatment for the weak base C₂H₅NH₂.</p>
              <p>From the mixture you chose, the concentration of C₂H₅NH₂ is approximately</p>
              <p style="margin-left:1.2rem;"><strong>[C₂H₅NH₂]₀ = ${c0} mol dm⁻³</strong>.</p>
              <p>We model the base equilibrium via its protonation:</p>
              <table>
                <thead>
                  <tr>
                    <th></th>
                    <th>C₂H₅NH₂</th>
                    <th>C₂H₅NH₃⁺</th>
                    <th>OH⁻</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td style="font-weight:600;">Initial</td>
                    <td>[C₂H₅NH₂]₀</td>
                    <td>0</td>
                    <td>0</td>
                  </tr>
                  <tr>
                    <td style="font-weight:600;">Change</td>
                    <td>-x</td>
                    <td>+x</td>
                    <td>+x</td>
                  </tr>
                  <tr>
                    <td style="font-weight:600;">Equilibrium</td>
                    <td>[C₂H₅NH₂]₀ - x</td>
                    <td>x</td>
                    <td>x</td>
                  </tr>
                </tbody>
              </table>
              <ol>
                <li>Write the equilibrium:
                  C₂H₅NH₂ + H₂O ⇌ C₂H₅NH₃⁺ + OH⁻.</li>
                <li>Use the ICE table above with dissociation <em>x</em> to express equilibrium concentrations.</li>
                <li>Write the base constant:
                  K<sub>b</sub> = [C₂H₅NH₃⁺][OH⁻] / [C₂H₅NH₂].</li>
                <li>Substitute the ICE expressions and, if [C₂H₅NH₂]₀ ≫ x, approximate
                  K<sub>b</sub> ≈ x² / [C₂H₅NH₂]₀.</li>
                <li>Solve for [OH⁻] ≈ √(K<sub>b</sub>[C₂H₅NH₂]₀), then convert to pOH and finally to pH.</li>
              </ol>
            `,
          };
        }

        if (kind === "buffer") {
          const V = state.totalVolumeL || 0;
          const cBase =
            V > 0 && state.nBaseFinal
              ? (state.nBaseFinal / V).toFixed(3)
              : "[base]";
          const cAcid =
            V > 0 && state.nSaltFinal
              ? (state.nSaltFinal / V).toFixed(3)
              : "[acid]";
          return {
            title: "Buffer calculation (C₂H₅NH₂ / C₂H₅NH₃⁺)",
            body: `
              <p>This walkthrough uses the Henderson–Hasselbalch idea for a weak base buffer.</p>
              <p>From the mixture you chose:</p>
              <p style="margin-left:1.2rem;">
                [C₂H₅NH₂] ≈ <strong>${cBase}</strong> mol dm⁻³<br />
                [C₂H₅NH₃⁺] ≈ <strong>${cAcid}</strong> mol dm⁻³
              </p>
              <ol>
                <li>Confirm that both C₂H₅NH₂ (base) and C₂H₅NH₃⁺ (conjugate acid) are present in significant amounts.</li>
                <li>Use the base‑form Henderson–Hasselbalch equation:
                  pOH = pK<sub>b</sub> + log([C₂H₅NH₃⁺] / [C₂H₅NH₂]).</li>
                <li>Compute the ratio [conjugate acid] / [base] from the concentrations above.</li>
                <li>Evaluate pOH, then convert to pH via pH = 14 − pOH.</li>
                <li>When [C₂H₅NH₂] ≈ [C₂H₅NH₃⁺] (as in the 50–50 case), the log term is close to zero and
                  pOH ≈ pK<sub>b</sub>, so pH ≈ 14 − pK<sub>b</sub>. This corresponds to maximum buffering capacity.</li>
              </ol>
            `,
          };
        }

        if (kind === "salt-hydrolysis") {
          const V = state.totalVolumeL || 0;
          const cSalt =
            V > 0 && state.nSaltFinal
              ? (state.nSaltFinal / V).toFixed(3)
              : "[C₂H₅NH₃⁺]₀";
          return {
            title: "Salt hydrolysis (C₂H₅NH₃⁺)",
            body: `
              <p>This walkthrough treats the conjugate acid C₂H₅NH₃⁺ as a weak acid undergoing hydrolysis.</p>
              <p>From the mixture you chose, the starting concentration is</p>
              <p style="margin-left:1.2rem;"><strong>[C₂H₅NH₃⁺]₀ ≈ ${cSalt} mol dm⁻³</strong>.</p>
              <p>First, obtain K<sub>a</sub> for C₂H₅NH₃⁺ from K<sub>b</sub>(C₂H₅NH₂) and K<sub>w</sub>:</p>
              <p style="margin-left:1.2rem;">
                K<sub>a</sub> = K<sub>w</sub> / K<sub>b</sub>(C₂H₅NH₂).
              </p>
              <p>Set up the hydrolysis equilibrium and ICE table:</p>
              <table>
                <thead>
                  <tr>
                    <th></th>
                    <th>C₂H₅NH₃⁺</th>
                    <th>C₂H₅NH₂</th>
                    <th>H⁺</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td style="font-weight:600;">Initial</td>
                    <td>[C₂H₅NH₃⁺]₀</td>
                    <td>0</td>
                    <td>0</td>
                  </tr>
                  <tr>
                    <td style="font-weight:600;">Change</td>
                    <td>-x</td>
                    <td>+x</td>
                    <td>+x</td>
                  </tr>
                  <tr>
                    <td style="font-weight:600;">Equilibrium</td>
                    <td>[C₂H₅NH₃⁺]₀ - x</td>
                    <td>x</td>
                    <td>x</td>
                  </tr>
                </tbody>
              </table>
              <ol>
                <li>Write the hydrolysis equilibrium:
                  C₂H₅NH₃⁺ + H₂O ⇌ C₂H₅NH₂ + H₃O⁺ (or H⁺).</li>
                <li>Use the ICE table above to express equilibrium concentrations in terms of <em>x</em>.</li>
                <li>Write the acid constant:
                  K<sub>a</sub> = [C₂H₅NH₂][H⁺] / [C₂H₅NH₃⁺].</li>
                <li>If [C₂H₅NH₃⁺]₀ ≫ x, approximate K<sub>a</sub> ≈ x² / [C₂H₅NH₃⁺]₀ and solve for x = [H⁺].</li>
                <li>Convert [H⁺] to pH and check that the small‑<em>x</em> assumption is consistent with the initial concentration.</li>
              </ol>
            `,
          };
        }

        return {
          title: "Derivation",
          body:
            "<p>Select a mixture and complete the flow to see the tailored derivation for this case.</p>",
        };
      }

      showWorkingBtn.addEventListener("click", () => {
        const kind = computedState ? computedState.classification : null;
        const { title, body } = getModalContent(kind, computedState);
        modalTitle.textContent = title;
        modalBody.innerHTML = body;
        modalBackdrop.classList.add("show");
      });

      // Event wiring
      document
        .querySelectorAll('.card[data-reagent-set]')
        .forEach((card) => {
          card.addEventListener("click", () => {
            selectReagentSet(card.dataset.reagentSet);
          });
        });

      studentDecisionOptions.addEventListener("change", (e) => {
        const target = e.target;
        if (target && target.name === "student-decision") {
          handleStudentDecision(target.value);
        }
      });

      calcDecisionOptions.addEventListener("change", (e) => {
        const target = e.target;
        if (target && target.name === "calc-decision") {
          handleCalcDecision(target.value);
        }
      });

      function performRestartLevel2() {
        selectedReagentSet = null;
        selectedCaseId = null;
        computedState = null;
        mixtureStrip.hidden = true;
        decisionFeedback.textContent = "";
        calcDecisionFeedback.textContent = "";

        document
          .querySelectorAll('.card[data-reagent-set]')
          .forEach((card) => card.classList.remove("selected"));

        caseOptionsEl.innerHTML = "";

        resetQuizState();
        goToStep(1);
      }

      restartBtn.addEventListener("click", () => {
        performRestartLevel2();
      });

      restartBtnRight.addEventListener("click", () => {
        performRestartLevel2();
      });

      closeModalBtn.addEventListener("click", () => {
        modalBackdrop.classList.remove("show");
      });

      modalBackdrop.addEventListener("click", (e) => {
        if (e.target === modalBackdrop) {
          modalBackdrop.classList.remove("show");
        }
      });

      // Allow going backwards via the stepper (for completed steps)
      stepperEl.querySelectorAll(".stepper-step").forEach((stepEl) => {
        stepEl.addEventListener("click", () => {
          const step = Number(stepEl.dataset.step);
          if (step >= currentStep) return;
          goToStep(step);
        });
      });

      // Initial render
      goToStep(1);
    </script>
  </body>
  </html>
